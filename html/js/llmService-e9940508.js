import{D as c,K as m,A as d}from"./llmConfig-57c9aed2.js";class w{async sendMessage(e,o={}){const s={...c,...o},r=d[s.provider];if(!r)throw new Error(`不支持的提供商: ${s.provider}`);if(!r.apiKey||!r.apiKey.trim())throw new Error(`${r.name} 的API密钥未配置`);const t=this._buildRequestBody(e,s,r);try{const i=new AbortController,h=setTimeout(()=>i.abort(),s.timeout),n=await fetch(r.baseUrl,{method:"POST",headers:{...r.headers,Authorization:`Bearer ${r.apiKey.trim()}`},body:JSON.stringify(t),signal:i.signal});if(clearTimeout(h),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const l=await n.json();return this._processResponse(l,t,s)}catch(i){return this._handleError(i,r.name)}}_buildRequestBody(e,o,s){let r={model:o.model,messages:e,temperature:o.temperature,max_tokens:o.maxTokens};return o.provider==="kimi"&&s.supportsTools&&(r.tools=m,r.tool_choice="auto"),r}_processResponse(e,o,s){if(e.error)throw e.error.code==="invalid_api_key"||e.error.type==="invalid_api_key"?new Error("API密钥无效，请检查配置"):new Error(e.error.message||"请求失败");if(!e.choices||!e.choices[0])throw new Error("响应格式异常");const r=e.choices[0].message;return r.usage=e.usage,r.model=o.model,r.provider=s.provider,r}_handleError(e,o){throw e.name==="AbortError"?new Error("请求超时，请稍后重试"):e.message.includes("API密钥")?e:e.message.includes("HTTP")?new Error(`${o} 服务异常: ${e.message}`):new Error(`网络错误: ${e.message}`)}async validateApiKey(e,o=c.provider){const s=d[o];if(!s)throw new Error(`不支持的提供商: ${o}`);if(!e||!e.trim())throw new Error("请输入API密钥");try{const t=await(await fetch(s.baseUrl,{method:"POST",headers:{...s.headers,Authorization:`Bearer ${e.trim()}`},body:JSON.stringify({model:o==="kimi"?"moonshot-v1-8k":s.defaultModel,messages:[{role:"user",content:"test"}],max_tokens:5})})).json();if(t.error)throw t.error.code==="invalid_api_key"||t.error.type==="invalid_api_key"?new Error("API密钥无效，请检查后重试"):new Error(t.error.message||"验证失败");return!0}catch(r){throw r.message.includes("API密钥")?r:new Error("网络错误或服务不可用，请稍后重试")}}}const u=new w,p=(a,e)=>u.sendMessage(a,e),y=p;export{y as a,p as s};
//# sourceMappingURL=llmService-e9940508.js.map
