{"version":3,"file":"indexedDB-a78e6341.js","sources":["../../front/src/utils/indexedDB.js"],"sourcesContent":["const DB_NAME = 'THSAutoTrader';\r\nconst DB_VERSION = 3;\r\nconst STORES = {\r\n  ASSET_INFO: 'assetInfo',\r\n  POSITION_DATA: 'positionData',\r\n  KLINE_DATA: 'klineData',\r\n  ANALYSIS_RESULTS: 'analysisResults',\r\n};\r\n\r\nclass IndexedDBUtil {\r\n  constructor() {\r\n    this.db = null;\r\n  }\r\n\r\n  // 初始化数据库\r\n  async init() {\r\n    return new Promise((resolve, reject) => {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n      request.onerror = (event) => {\r\n        reject('数据库打开失败');\r\n      };\r\n\r\n      request.onsuccess = (event) => {\r\n        this.db = event.target.result;\r\n        resolve();\r\n      };\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        const db = event.target.result;\r\n        // 创建资产信息存储\r\n        if (!db.objectStoreNames.contains(STORES.ASSET_INFO)) {\r\n          db.createObjectStore(STORES.ASSET_INFO, { keyPath: 'id' });\r\n        }\r\n        // 创建持仓数据存储\r\n        if (!db.objectStoreNames.contains(STORES.POSITION_DATA)) {\r\n          db.createObjectStore(STORES.POSITION_DATA, { keyPath: 'id' });\r\n        }\r\n        // 创建 K 线数据存储\r\n        if (!db.objectStoreNames.contains(STORES.KLINE_DATA)) {\r\n          db.createObjectStore(STORES.KLINE_DATA, { keyPath: 'code' });\r\n        }\r\n        // 创建分析结果存储\r\n        if (!db.objectStoreNames.contains(STORES.ANALYSIS_RESULTS)) {\r\n          db.createObjectStore(STORES.ANALYSIS_RESULTS, { keyPath: 'stockCode' });\r\n        }\r\n      };\r\n    });\r\n  }\r\n\r\n  // 保存数据\r\n  async saveData(storeName, data, key = 1) {\r\n    if (!this.db) {\r\n      await this.init();\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = this.db.transaction([storeName], 'readwrite');\r\n      const store = transaction.objectStore(storeName);\r\n      \r\n      let record;\r\n      if (storeName === STORES.KLINE_DATA) {\r\n        record = { code: key, data, timestamp: Date.now() };\r\n      } else if (storeName === STORES.ANALYSIS_RESULTS) {\r\n        record = { stockCode: key, ...data, timestamp: Date.now() };\r\n      } else {\r\n        record = { id: key, data, timestamp: Date.now() };\r\n      }\r\n      \r\n      const request = store.put(record);\r\n\r\n      request.onsuccess = () => resolve();\r\n      request.onerror = () => reject('数据保存失败');\r\n    });\r\n  }\r\n\r\n  // 获取数据\r\n  async getData(storeName, key = 1) {\r\n    if (!this.db) {\r\n      await this.init();\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = this.db.transaction([storeName], 'readonly');\r\n      const store = transaction.objectStore(storeName);\r\n      const request = store.get(key);\r\n\r\n      request.onsuccess = () => resolve(request.result);\r\n      request.onerror = () => reject('数据获取失败');\r\n    });\r\n  }\r\n\r\n  // 检查数据是否过期（默认5分钟）\r\n  isDataExpired(timestamp, maxAge = 5 * 60 * 1000) {\r\n    // 返回 false 表示数据永不过期\r\n    return false;\r\n  }\r\n}\r\n\r\n// 创建实例\r\nexport const indexedDBUtil = new IndexedDBUtil();\r\nexport const STORE_NAMES = STORES;\r\nexport { DB_NAME, DB_VERSION };\r\n\r\n// 保存分析结果\r\nexport const saveAnalysisResult = async (stockCode, result) => {\r\n  try {\r\n    await indexedDBUtil.saveData(STORES.ANALYSIS_RESULTS, result, stockCode);\r\n  } catch (error) {\r\n    console.error('保存分析结果失败:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// 获取分析结果\r\nexport const getAnalysisResult = async (stockCode) => {\r\n  try {\r\n    const result = await indexedDBUtil.getData(STORES.ANALYSIS_RESULTS, stockCode);\r\n    // 分析结果存储时已经展开，直接返回\r\n    return result || null;\r\n  } catch (error) {\r\n    console.error('获取分析结果失败:', error);\r\n    return null;\r\n  }\r\n};\r\n\r\n// 获取所有分析结果\r\nexport const getAllAnalysisResults = async () => {\r\n  try {\r\n    if (!indexedDBUtil.db) {\r\n      await indexedDBUtil.init();\r\n    }\r\n    \r\n    return new Promise((resolve, reject) => {\r\n      const transaction = indexedDBUtil.db.transaction([STORES.ANALYSIS_RESULTS], 'readonly');\r\n      const store = transaction.objectStore(STORES.ANALYSIS_RESULTS);\r\n      const request = store.getAll();\r\n      \r\n      request.onsuccess = () => {\r\n        const results = {};\r\n        request.result.forEach(item => {\r\n          results[item.stockCode] = item;\r\n        });\r\n        resolve(results);\r\n      };\r\n      \r\n      request.onerror = () => reject('获取所有分析结果失败');\r\n    });\r\n  } catch (error) {\r\n    console.error('获取所有分析结果失败:', error);\r\n    return {};\r\n  }\r\n};\r\n"],"names":["DB_NAME","STORES","IndexedDBUtil","resolve","reject","request","event","db","storeName","data","key","store","record","timestamp","maxAge","indexedDBUtil","STORE_NAMES","saveAnalysisResult","stockCode","result","error","getAnalysisResult","getAllAnalysisResults","results","item"],"mappings":"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"}