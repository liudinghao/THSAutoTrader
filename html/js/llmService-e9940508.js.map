{"version":3,"file":"llmService-e9940508.js","sources":["../../front/src/services/llmService.js"],"sourcesContent":["/**\r\n * LLM服务层\r\n * 处理具体的API调用和业务逻辑\r\n */\r\n\r\nimport { API_PROVIDERS, DEFAULT_CONFIG, REQUEST_CONFIG, KIMI_TOOLS } from './llmConfig.js'\r\n\r\n/**\r\n * LLM服务类\r\n */\r\nclass LLMService {\r\n  /**\r\n   * 发送消息到LLM\r\n   * @param {Array} messages 消息数组\r\n   * @param {Object} config 配置选项\r\n   * @returns {Promise<Object>} API响应\r\n   */\r\n  async sendMessage(messages, config = {}) {\r\n    // 合并配置\r\n    const finalConfig = { ...DEFAULT_CONFIG, ...config }\r\n    const providerConfig = API_PROVIDERS[finalConfig.provider]\r\n    \r\n    if (!providerConfig) {\r\n      throw new Error(`不支持的提供商: ${finalConfig.provider}`)\r\n    }\r\n\r\n    // 验证API密钥\r\n    if (!providerConfig.apiKey || !providerConfig.apiKey.trim()) {\r\n      throw new Error(`${providerConfig.name} 的API密钥未配置`)\r\n    }\r\n\r\n    // 构建请求体\r\n    const requestBody = this._buildRequestBody(messages, finalConfig, providerConfig)\r\n\r\n    // 发送请求\r\n    try {\r\n      const controller = new AbortController()\r\n      const timeoutId = setTimeout(() => controller.abort(), finalConfig.timeout)\r\n\r\n      const response = await fetch(providerConfig.baseUrl, {\r\n        method: 'POST',\r\n        headers: {\r\n          ...providerConfig.headers,\r\n          'Authorization': `Bearer ${providerConfig.apiKey.trim()}`,\r\n        },\r\n        body: JSON.stringify(requestBody),\r\n        signal: controller.signal\r\n      })\r\n\r\n      clearTimeout(timeoutId)\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      return this._processResponse(data, requestBody, finalConfig)\r\n\r\n    } catch (error) {\r\n      return this._handleError(error, providerConfig.name)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 构建请求体\r\n   * @private\r\n   */\r\n  _buildRequestBody(messages, config, providerConfig) {\r\n    let requestBody = {\r\n      model: config.model,\r\n      messages,\r\n      temperature: config.temperature,\r\n      max_tokens: config.maxTokens\r\n    }\r\n\r\n    // Kimi支持工具调用\r\n    if (config.provider === 'kimi' && providerConfig.supportsTools) {\r\n      requestBody.tools = KIMI_TOOLS\r\n      requestBody.tool_choice = 'auto'\r\n    }\r\n\r\n    return requestBody\r\n  }\r\n\r\n  /**\r\n   * 处理API响应\r\n   * @private\r\n   */\r\n  _processResponse(data, requestBody, config) {\r\n    if (data.error) {\r\n      if (data.error.code === 'invalid_api_key' || data.error.type === 'invalid_api_key') {\r\n        throw new Error('API密钥无效，请检查配置')\r\n      }\r\n      throw new Error(data.error.message || '请求失败')\r\n    }\r\n\r\n    if (!data.choices || !data.choices[0]) {\r\n      throw new Error('响应格式异常')\r\n    }\r\n\r\n    // 为了兼容原有代码，返回消息对象格式\r\n    const result = data.choices[0].message\r\n    result.usage = data.usage\r\n    result.model = requestBody.model  \r\n    result.provider = config.provider\r\n    return result\r\n  }\r\n\r\n  /**\r\n   * 错误处理\r\n   * @private\r\n   */\r\n  _handleError(error, providerName) {\r\n    if (error.name === 'AbortError') {\r\n      throw new Error('请求超时，请稍后重试')\r\n    }\r\n    \r\n    if (error.message.includes('API密钥')) {\r\n      throw error\r\n    }\r\n    \r\n    if (error.message.includes('HTTP')) {\r\n      throw new Error(`${providerName} 服务异常: ${error.message}`)\r\n    }\r\n    \r\n    throw new Error(`网络错误: ${error.message}`)\r\n  }\r\n\r\n  /**\r\n   * 验证API密钥\r\n   * @param {string} apiKey API密钥\r\n   * @param {string} provider 提供商\r\n   * @returns {Promise<boolean>} 验证结果\r\n   */\r\n  async validateApiKey(apiKey, provider = DEFAULT_CONFIG.provider) {\r\n    const providerConfig = API_PROVIDERS[provider]\r\n    \r\n    if (!providerConfig) {\r\n      throw new Error(`不支持的提供商: ${provider}`)\r\n    }\r\n    \r\n    if (!apiKey || !apiKey.trim()) {\r\n      throw new Error('请输入API密钥')\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(providerConfig.baseUrl, {\r\n        method: 'POST',\r\n        headers: {\r\n          ...providerConfig.headers,\r\n          'Authorization': `Bearer ${apiKey.trim()}`,\r\n        },\r\n        body: JSON.stringify({\r\n          model: provider === 'kimi' ? 'moonshot-v1-8k' : providerConfig.defaultModel,\r\n          messages: [{ role: 'user', content: 'test' }],\r\n          max_tokens: 5,\r\n        }),\r\n      })\r\n\r\n      const data = await response.json()\r\n\r\n      if (data.error) {\r\n        if (data.error.code === 'invalid_api_key' || data.error.type === 'invalid_api_key') {\r\n          throw new Error('API密钥无效，请检查后重试')\r\n        }\r\n        throw new Error(data.error.message || '验证失败')\r\n      }\r\n\r\n      return true\r\n    } catch (error) {\r\n      if (error.message.includes('API密钥')) {\r\n        throw error\r\n      }\r\n      throw new Error('网络错误或服务不可用，请稍后重试')\r\n    }\r\n  }\r\n}\r\n\r\n// 创建单例实例\r\nexport const llmService = new LLMService()\r\n\r\n// 导出便捷函数\r\nexport const sendLLMMessage = (messages, config) => llmService.sendMessage(messages, config)\r\nexport const validateLLMApiKey = (apiKey, provider) => llmService.validateApiKey(apiKey, provider)\r\n\r\n// 兼容性导出\r\nexport const sendMessage = sendLLMMessage\r\nexport const validateApiKey = validateLLMApiKey"],"names":["LLMService","messages","config","finalConfig","DEFAULT_CONFIG","providerConfig","API_PROVIDERS","requestBody","controller","timeoutId","response","data","error","KIMI_TOOLS","result","providerName","apiKey","provider","llmService","sendLLMMessage","sendMessage"],"mappings":"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"}