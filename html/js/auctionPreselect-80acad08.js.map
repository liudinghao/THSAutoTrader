{"version":3,"file":"auctionPreselect-80acad08.js","sources":["../../front/src/strategies/auctionPreselect.js"],"sourcesContent":["/**\r\n * 竞价选股策略\r\n * 基于集合竞价数据进行股票筛选，过滤出竞价涨跌幅在指定范围内的股票\r\n */\r\n\r\nimport { fetchHistoryData } from '@/utils/quoteApi.js'\r\nimport axios from 'axios'\r\n\r\n/**\r\n * 竞价选股策略配置\r\n */\r\nexport const AUCTION_PRESELECT_CONFIG = {\r\n  // 默认竞价涨跌幅过滤范围\r\n  MIN_CHANGE_PERCENT: 3, // 最小涨跌幅 3%\r\n  MAX_CHANGE_PERCENT: 5, // 最大涨跌幅 5%\r\n\r\n  // 批处理配置\r\n  BATCH_SIZE: 100, // 每批处理股票数量\r\n  BATCH_DELAY: 200, // 批次间延迟(ms)\r\n\r\n  // API配置\r\n  API_URL: 'https://www.wttiao.com/moni/ztpool/auction-preselect'\r\n}\r\n\r\n/**\r\n * 竞价选股策略主函数\r\n * @param {Object} params 策略参数\r\n * @param {string} params.date 回测日期，格式: YYYY-MM-DD\r\n * @param {number} params.minChange 最小竞价涨跌幅，默认3%\r\n * @param {number} params.maxChange 最大竞价涨跌幅，默认5%\r\n * @param {Function} params.onProgress 进度回调函数，可选\r\n * @returns {Promise<Object>} 策略执行结果\r\n */\r\nexport async function executeAuctionPreselect(params = {}) {\r\n  const {\r\n    date,\r\n    minChange = AUCTION_PRESELECT_CONFIG.MIN_CHANGE_PERCENT,\r\n    maxChange = AUCTION_PRESELECT_CONFIG.MAX_CHANGE_PERCENT,\r\n    onProgress\r\n  } = params\r\n\r\n  if (!date) {\r\n    throw new Error('请指定回测日期')\r\n  }\r\n\r\n  const result = {\r\n    date,\r\n    originalCount: 0,\r\n    filteredCount: 0,\r\n    stocks: [],\r\n    filterCriteria: {\r\n      minChange,\r\n      maxChange\r\n    },\r\n    executionTime: Date.now()\r\n  }\r\n\r\n  try {\r\n    // 报告进度\r\n    onProgress && onProgress('正在获取预选股票列表...', 0)\r\n\r\n    // 第一步：获取预选股票列表\r\n    const originalStocks = await fetchPreselectedStocks(date)\r\n    result.originalCount = originalStocks.length\r\n\r\n    onProgress && onProgress(`获取到 ${originalStocks.length} 只预选股票，开始计算竞价涨跌幅...`, 20)\r\n\r\n    // 第二步：分批获取行情数据并计算竞价涨跌幅\r\n    const stocksWithAuctionData = await calculateAuctionChanges(originalStocks, date, onProgress)\r\n    \r\n    // 第三步：根据竞价涨跌幅过滤股票\r\n    const filteredStocks = filterByAuctionChange(stocksWithAuctionData, minChange, maxChange)\r\n\r\n    result.filteredCount = filteredStocks.length\r\n    result.stocks = filteredStocks\r\n    result.executionTime = Date.now() - result.executionTime\r\n\r\n    onProgress && onProgress(`策略执行完成，找到 ${filteredStocks.length} 只符合条件的股票`, 100)\r\n\r\n    return result\r\n\r\n  } catch (error) {\r\n    console.error('竞价选股策略执行失败:', error)\r\n    throw new Error(`竞价选股策略执行失败: ${error.message}`)\r\n  }\r\n}\r\n\r\n/**\r\n * 获取预选股票列表\r\n * @param {string} date 日期，格式: YYYY-MM-DD\r\n * @returns {Promise<Array>} 预选股票列表\r\n */\r\nexport async function fetchPreselectedStocks(date) {\r\n  try {\r\n    const response = await axios.get(AUCTION_PRESELECT_CONFIG.API_URL, {\r\n      params: { date }\r\n    })\r\n\r\n    if (response.data.code !== 0) {\r\n      throw new Error(`API返回错误: ${response.data.msg}`)\r\n    }\r\n\r\n    return response.data.data || []\r\n  } catch (error) {\r\n    throw new Error(`获取预选股票失败: ${error.message}`)\r\n  }\r\n}\r\n\r\n/**\r\n * 分批计算股票的竞价涨跌幅\r\n * @param {Array} stocks 股票列表\r\n * @param {string} date 日期，格式: YYYY-MM-DD\r\n * @param {Function} onProgress 进度回调函数\r\n * @returns {Promise<Array>} 包含竞价涨跌幅的股票列表\r\n */\r\nexport async function calculateAuctionChanges(stocks, date, onProgress) {\r\n  const { BATCH_SIZE, BATCH_DELAY } = AUCTION_PRESELECT_CONFIG\r\n  const dateFormatted = date.replace(/-/g, '') // 转换为YYYYMMDD格式\r\n  const stocksWithData = []\r\n  const totalBatches = Math.ceil(stocks.length / BATCH_SIZE)\r\n\r\n  for (let i = 0; i < stocks.length; i += BATCH_SIZE) {\r\n    const batch = stocks.slice(i, i + BATCH_SIZE)\r\n    const batchIndex = Math.floor(i / BATCH_SIZE) + 1\r\n\r\n    try {\r\n      // 报告进度\r\n      const progress = 20 + (batchIndex / totalBatches) * 60 // 20-80%的进度\r\n      onProgress && onProgress(`正在处理第 ${batchIndex}/${totalBatches} 批股票 (${batch.length} 只)`, progress)\r\n\r\n      // 构造股票代码列表，需要加上市场代码\r\n      const stockCodes = batch.map(stock => formatStockCode(stock.code))\r\n\r\n      // 获取历史行情数据\r\n      const historyData = await fetchHistoryData(stockCodes, dateFormatted, dateFormatted)\r\n\r\n      // 处理每只股票的数据\r\n      batch.forEach(stock => {\r\n        const marketCode = formatStockCode(stock.code)\r\n        const stockData = historyData[marketCode]\r\n        const auctionChange = calculateSingleAuctionChange(stockData, dateFormatted)\r\n        const closeChange = calculateSingleCloseChange(stockData, dateFormatted)\r\n\r\n        stocksWithData.push({\r\n          ...stock,\r\n          auction_change: auctionChange,\r\n          close_change: closeChange,\r\n          market_code: marketCode\r\n        })\r\n      })\r\n\r\n      // 添加延迟避免API调用过快\r\n      if (i + BATCH_SIZE < stocks.length) {\r\n        await new Promise(resolve => setTimeout(resolve, BATCH_DELAY))\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error(`第 ${batchIndex} 批股票获取行情数据失败:`, error)\r\n\r\n      // 即使失败也要添加股票到结果中，只是竞价涨跌幅和收盘涨跌幅为null\r\n      batch.forEach(stock => {\r\n        stocksWithData.push({\r\n          ...stock,\r\n          auction_change: null,\r\n          close_change: null,\r\n          market_code: formatStockCode(stock.code),\r\n          error: error.message\r\n        })\r\n      })\r\n    }\r\n  }\r\n\r\n  return stocksWithData\r\n}\r\n\r\n/**\r\n * 格式化股票代码，添加市场前缀\r\n * @param {string} code 股票代码\r\n * @returns {string} 带市场前缀的股票代码\r\n */\r\nexport function formatStockCode(code) {\r\n  return code;\r\n}\r\n\r\n/**\r\n * 计算单只股票的竞价涨跌幅\r\n * @param {Object} stockData 股票历史数据\r\n * @param {string} dateFormatted 格式化的日期 YYYYMMDD\r\n * @returns {number|null} 竞价涨跌幅百分比，保留2位小数\r\n */\r\nexport function calculateSingleAuctionChange(stockData, dateFormatted) {\r\n  if (!stockData || !stockData[dateFormatted]) {\r\n    return null\r\n  }\r\n\r\n  const dayData = stockData[dateFormatted]\r\n  const openPrice = parseFloat(dayData.OPEN)\r\n  const prePrice = parseFloat(dayData.PRE)\r\n\r\n  if (isNaN(openPrice) || isNaN(prePrice) || prePrice <= 0) {\r\n    return null\r\n  }\r\n\r\n  // 计算竞价涨跌幅 = (开盘价 - 昨收价) / 昨收价 * 100\r\n  const changePercent = ((openPrice - prePrice) / prePrice) * 100\r\n  return parseFloat(changePercent.toFixed(2))\r\n}\r\n\r\n/**\r\n * 计算单只股票的当日收盘涨跌幅\r\n * @param {Object} stockData 股票历史数据\r\n * @param {string} dateFormatted 格式化的日期 YYYYMMDD\r\n * @returns {number|null} 收盘涨跌幅百分比，保留2位小数\r\n */\r\nexport function calculateSingleCloseChange(stockData, dateFormatted) {\r\n  if (!stockData || !stockData[dateFormatted]) {\r\n    return null\r\n  }\r\n\r\n  const dayData = stockData[dateFormatted]\r\n  const closePrice = parseFloat(dayData.CLOSE)\r\n  const prePrice = parseFloat(dayData.PRE)\r\n\r\n  if (isNaN(closePrice) || isNaN(prePrice) || prePrice <= 0) {\r\n    return null\r\n  }\r\n\r\n  // 计算收盘涨跌幅 = (收盘价 - 昨收价) / 昨收价 * 100\r\n  const changePercent = ((closePrice - prePrice) / prePrice) * 100\r\n  return parseFloat(changePercent.toFixed(2))\r\n}\r\n\r\n/**\r\n * 根据竞价涨跌幅过滤股票\r\n * @param {Array} stocks 包含竞价涨跌幅的股票列表\r\n * @param {number} minChange 最小涨跌幅\r\n * @param {number} maxChange 最大涨跌幅\r\n * @returns {Array} 过滤后的股票列表\r\n */\r\nexport function filterByAuctionChange(stocks, minChange, maxChange) {\r\n  return stocks.filter(stock => {\r\n    const change = stock.auction_change\r\n    return change !== null &&\r\n           change !== undefined &&\r\n           change >= minChange &&\r\n           change <= maxChange\r\n  })\r\n}\r\n\r\n/**\r\n * 竞价选股策略分析\r\n * 提供策略的详细分析结果\r\n * @param {Array} filteredStocks 过滤后的股票列表\r\n * @returns {Object} 分析结果\r\n */\r\nexport function analyzeAuctionStrategy(filteredStocks) {\r\n  if (!Array.isArray(filteredStocks) || filteredStocks.length === 0) {\r\n    return {\r\n      count: 0,\r\n      avgChange: 0,\r\n      changeRange: { min: 0, max: 0 },\r\n      distribution: {},\r\n      topReasons: []\r\n    }\r\n  }\r\n\r\n  // 计算基础统计\r\n  const validChanges = filteredStocks\r\n    .map(stock => stock.auction_change)\r\n    .filter(change => change !== null && change !== undefined)\r\n\r\n  const avgChange = validChanges.length > 0\r\n    ? parseFloat((validChanges.reduce((sum, change) => sum + change, 0) / validChanges.length).toFixed(2))\r\n    : 0\r\n\r\n  const changeRange = {\r\n    min: validChanges.length > 0 ? Math.min(...validChanges) : 0,\r\n    max: validChanges.length > 0 ? Math.max(...validChanges) : 0\r\n  }\r\n\r\n  // 分析涨跌幅分布\r\n  const distribution = {}\r\n  validChanges.forEach(change => {\r\n    const range = Math.floor(change)\r\n    distribution[range] = (distribution[range] || 0) + 1\r\n  })\r\n\r\n  // 分析选股原因\r\n  const reasonCount = {}\r\n  filteredStocks.forEach(stock => {\r\n    if (stock.reason_type) {\r\n      const reasons = stock.reason_type.split(',').map(r => r.trim())\r\n      reasons.forEach(reason => {\r\n        reasonCount[reason] = (reasonCount[reason] || 0) + 1\r\n      })\r\n    }\r\n  })\r\n\r\n  const topReasons = Object.entries(reasonCount)\r\n    .sort(([,a], [,b]) => b - a)\r\n    .slice(0, 5)\r\n    .map(([reason, count]) => ({ reason, count }))\r\n\r\n  return {\r\n    count: filteredStocks.length,\r\n    avgChange,\r\n    changeRange,\r\n    distribution,\r\n    topReasons\r\n  }\r\n}\r\n\r\n/**\r\n * 竞价选股策略默认导出对象\r\n */\r\nexport default {\r\n  name: '竞价选股策略',\r\n  description: '基于集合竞价涨跌幅筛选股票，适用于短线交易策略',\r\n  version: '1.0.0',\r\n  author: 'THS AutoTrader',\r\n\r\n  // 策略配置\r\n  config: AUCTION_PRESELECT_CONFIG,\r\n\r\n  // 主要方法\r\n  execute: executeAuctionPreselect,\r\n  fetchPreselectedStocks,\r\n  calculateAuctionChanges,\r\n  filterByAuctionChange,\r\n  analyzeAuctionStrategy,\r\n\r\n  // 工具方法\r\n  formatStockCode,\r\n  calculateSingleAuctionChange,\r\n  calculateSingleCloseChange\r\n}"],"names":["AUCTION_PRESELECT_CONFIG","executeAuctionPreselect","params","date","minChange","maxChange","onProgress","result","originalStocks","fetchPreselectedStocks","stocksWithAuctionData","calculateAuctionChanges","filteredStocks","filterByAuctionChange","error","response","axios","stocks","BATCH_SIZE","BATCH_DELAY","dateFormatted","stocksWithData","totalBatches","i","batch","batchIndex","progress","stockCodes","stock","historyData","fetchHistoryData","marketCode","stockData","auctionChange","calculateSingleAuctionChange","closeChange","calculateSingleCloseChange","resolve","dayData","openPrice","prePrice","changePercent","closePrice","change"],"mappings":"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"}