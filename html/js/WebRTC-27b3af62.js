import{_ as H,k as h,c as K,C as Q,D as U,r as m,o as b,g as k,d as s,w as r,E as v,b as i,u as X,e as D,f as w,F as Z,i as ee,j as te,Y as ne}from"./index-56f3e32a.js";const ae={class:"webrtc-container"},oe={class:"card-header"},se={class:"connection-info"},ce={class:"status-panel"},re={class:"peer-count"},le={class:"message-actions"},ie={class:"message-list"},de={class:"message-meta"},ue={class:"sender"},fe={class:"time"},pe={class:"message-content"},me={key:0,class:"empty-message"},_e={__name:"WebRTC",setup(ve){const u=h({signalingServer:"ws://localhost:8000",roomId:"default-room",userId:`user_${Math.random().toString(36).substr(2,9)}`}),g=h(""),C=h([]),_=h(!1),p=h(!1),S=h(0);let o=null,l=new Map,d=new Map;const x=K(()=>p.value?{type:"success",text:"已连接"}:_.value?{type:"warning",text:"连接中..."}:{type:"info",text:"未连接"}),M=async()=>{p.value?E():await O()},O=async()=>{_.value=!0;try{await P(),v.success("连接信令服务器成功")}catch(t){v.error(`连接失败: ${t.message}`),_.value=!1}},E=()=>{o&&o.close(),l.forEach(t=>{try{t.close()}catch{}}),d.forEach(t=>{try{t.close()}catch{}}),l.clear(),d.clear(),p.value=!1,_.value=!1,S.value=0,v.info("连接已断开")},P=()=>new Promise((t,e)=>{o=new WebSocket(u.value.signalingServer),o.onopen=()=>{p.value=!0,_.value=!1,o.send(JSON.stringify({type:"join",room:u.value.roomId,user:u.value.userId})),t()},o.onmessage=n=>{try{const a=JSON.parse(n.data);W(a)}catch{}},o.onerror=n=>{e(n)},o.onclose=()=>{p.value=!1,_.value=!1,l.forEach((n,a)=>{y(a)}),o=null}}),W=t=>{switch(t.type){case"offer":R(t);break;case"answer":L(t);break;case"ice-candidate":$(t);break;case"user-joined":j(t);break;case"user-left":z(t);break}},T=t=>{const e={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},n=new RTCPeerConnection(e);return l.set(t,n),n.oniceconnectionstatechange=()=>{(n.iceConnectionState==="failed"||n.iceConnectionState==="disconnected")&&setTimeout(()=>{(n.iceConnectionState==="failed"||n.iceConnectionState==="disconnected")&&y(t)},5e3)},n.onsignalingstatechange=()=>{},n.onconnectionstatechange=()=>{(n.connectionState==="failed"||n.connectionState==="closed")&&y(t)},n.ondatachannel=a=>{I(a.channel,t)},n.onicecandidate=a=>{if(a.candidate&&o&&o.readyState===WebSocket.OPEN)try{o.send(JSON.stringify({type:"ice-candidate",candidate:a.candidate,target:t}))}catch{}},n},I=(t,e)=>{t.onopen=()=>{d.set(e,t),S.value=d.size,v.success(`与 ${e} 建立数据通道`)},t.onmessage=n=>{try{const a=JSON.parse(n.data);C.value.push({sender:e,content:a.content,timestamp:a.timestamp||Date.now()})}catch{}},t.onclose=()=>{d.delete(e),l.delete(e),S.value=d.size,v.info(`${e} 断开连接`)},t.onerror=n=>{}},R=async t=>{const{from:e,offer:n}=t;if(l.has(e)){const c=l.get(e);if(c.connectionState!=="closed"&&c.connectionState!=="failed")return;c.close(),l.delete(e),d.delete(e)}const a=T(e);try{await a.setRemoteDescription(n);const c=await a.createAnswer();if(await a.setLocalDescription(c),o&&o.readyState===WebSocket.OPEN)try{o.send(JSON.stringify({type:"answer",answer:c,target:e}))}catch{}}catch{}},L=async t=>{const{from:e,answer:n}=t,a=l.get(e);if(a)try{await a.setRemoteDescription(n)}catch{}},$=async t=>{const{from:e,candidate:n}=t,a=l.get(e);if(a&&n)try{await a.addIceCandidate(n)}catch{}},j=async t=>{const{user:e}=t;if(e===u.value.userId||l.has(e))return;const n=T(e);try{const a=n.createDataChannel("trading");I(a,e);const c=await n.createOffer();if(await n.setLocalDescription(c),o&&o.readyState===WebSocket.OPEN)try{o.send(JSON.stringify({type:"offer",offer:c,target:e}))}catch{}}catch{}},y=t=>{const e=l.get(t);if(e)try{e.close()}catch{}const n=d.get(t);if(n)try{n.close()}catch{}l.delete(t),d.delete(t),S.value=d.size},z=t=>{const{user:e}=t;y(e),v.info(`${e} 离开房间`)},B=()=>{if(!g.value.trim())return;const t={content:g.value,timestamp:Date.now(),type:"text"};d.forEach((e,n)=>{if(e.readyState==="open")try{e.send(JSON.stringify(t))}catch{y(n)}}),C.value.push({sender:"我",content:g.value,timestamp:Date.now()}),g.value=""},F=()=>{const t={type:"test",content:"这是一条测试消息",timestamp:Date.now(),random:Math.random()};d.forEach((e,n)=>{if(e.readyState==="open")try{e.send(JSON.stringify(t))}catch{y(n)}}),v.success("测试数据已发送")},A=t=>new Date(t).toLocaleTimeString();return Q(()=>{O()}),U(()=>{E()}),(t,e)=>{const n=m("el-button"),a=m("el-input"),c=m("el-form-item"),V=m("el-form"),Y=m("el-tag"),N=m("el-card"),J=m("el-col"),q=m("el-row");return b(),k("div",ae,[s(N,{class:"connection-card"},{header:r(()=>[i("div",oe,[e[4]||(e[4]=i("h3",null,"WebRTC 实时通信",-1)),s(n,{type:"primary",icon:X(ne),onClick:M,loading:_.value},{default:r(()=>[D(w(p.value?"断开连接":"建立连接"),1)]),_:1},8,["icon","loading"])])]),default:r(()=>[i("div",se,[s(V,{model:u.value,"label-width":"120px"},{default:r(()=>[s(c,{label:"信令服务器地址"},{default:r(()=>[s(a,{modelValue:u.value.signalingServer,"onUpdate:modelValue":e[0]||(e[0]=f=>u.value.signalingServer=f),placeholder:"ws://localhost:8000"},null,8,["modelValue"])]),_:1}),s(c,{label:"房间ID"},{default:r(()=>[s(a,{modelValue:u.value.roomId,"onUpdate:modelValue":e[1]||(e[1]=f=>u.value.roomId=f),placeholder:"输入房间ID"},null,8,["modelValue"])]),_:1}),s(c,{label:"用户ID"},{default:r(()=>[s(a,{modelValue:u.value.userId,"onUpdate:modelValue":e[2]||(e[2]=f=>u.value.userId=f),placeholder:"输入用户ID"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),i("div",ce,[s(Y,{type:x.value.type},{default:r(()=>[D(w(x.value.text),1)]),_:1},8,["type"]),i("span",re," 已连接: "+w(S.value)+" 个节点 ",1)])]),_:1}),s(q,{gutter:20,class:"content-row"},{default:r(()=>[s(J,{span:12},{default:r(()=>[s(N,{class:"message-card"},{header:r(()=>e[5]||(e[5]=[i("h4",null,"发送消息",-1)])),default:r(()=>[s(a,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=f=>g.value=f),type:"textarea",rows:4,placeholder:"输入要发送的消息"},null,8,["modelValue"]),i("div",le,[s(n,{type:"primary",onClick:B,disabled:!p.value},{default:r(()=>e[6]||(e[6]=[D(" 发送消息 ")])),_:1,__:[6]},8,["disabled"]),s(n,{onClick:F,disabled:!p.value},{default:r(()=>e[7]||(e[7]=[D(" 发送测试数据 ")])),_:1,__:[7]},8,["disabled"])])]),_:1})]),_:1}),s(J,{span:12},{default:r(()=>[s(N,{class:"message-card"},{header:r(()=>e[8]||(e[8]=[i("h4",null,"接收消息",-1)])),default:r(()=>[i("div",ie,[(b(!0),k(Z,null,ee(C.value,(f,G)=>(b(),k("div",{key:G,class:"message-item"},[i("div",de,[i("span",ue,w(f.sender),1),i("span",fe,w(A(f.timestamp)),1)]),i("div",pe,w(f.content),1)]))),128)),C.value.length===0?(b(),k("div",me," 暂无消息 ")):te("",!0)])]),_:1})]),_:1})]),_:1})])}}},ye=H(_e,[["__scopeId","data-v-cd60a2f5"]]);export{ye as default};
//# sourceMappingURL=WebRTC-27b3af62.js.map
