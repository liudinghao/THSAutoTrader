var F=Object.defineProperty;var N=(s,e,t)=>e in s?F(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var S=(s,e,t)=>(N(s,typeof e!="symbol"?e+"":e,t),t);import{_ as D,M as b,m as T,r as u,o as p,g as K,d as h,w as f,e as w,f as B,N as A,O as q,P as j,v as O,a as y,b as k,i as Q,F as z}from"./index-14da2869.js";import{S as E}from"./StockTable-1df7f939.js";import{e as L,u as P,r as M,j as R}from"./quoteApi-9e449949.js";import{i as _,S as C}from"./indexedDB-a78e6341.js";import"./index-79ad53b8.js";const V={name:"StockPoolHeader",components:{Star:b,TrendCharts:T},props:{stockPool:{type:Array,required:!0},showKLine:{type:Boolean,required:!0}},data(){return{addingToSelf:!1}},methods:{async handleAddAllToSelf(){this.addingToSelf=!0;try{const s=this.stockPool.map(e=>e.code);await L(s),this.$emit("show-message",{type:"success",message:"所有股票已添加到自选股"})}catch(s){console.error("添加自选股失败:",s),this.$emit("show-message",{type:"error",message:"添加自选股失败: "+s.message})}finally{this.addingToSelf=!1}},toggleKLine(){this.$emit("update:showKLine",!this.showKLine),localStorage.setItem("showKLine",!this.showKLine)}}},H={class:"header-buttons"};function U(s,e,t,o,a,n){const l=u("Star"),d=u("el-icon"),r=u("el-button"),i=u("TrendCharts");return p(),K("div",H,[h(r,{type:"primary",size:"small",loading:a.addingToSelf,onClick:n.handleAddAllToSelf},{default:f(()=>[h(d,{class:"el-icon--left"},{default:f(()=>[h(l)]),_:1}),e[0]||(e[0]=w(" 一键加自选 "))]),_:1,__:[0]},8,["loading","onClick"]),h(r,{type:t.showKLine?"primary":"info",size:"small",onClick:n.toggleKLine},{default:f(()=>[h(d,{class:"el-icon--left"},{default:f(()=>[h(i)]),_:1}),w(" "+B(t.showKLine?"隐藏K线":"显示K线"),1)]),_:1},8,["type","onClick"])])}const W=D(V,[["render",U],["__scopeId","data-v-1cb7b934"]]);class Y{constructor(){S(this,"loadKLineData",q(async function(e,t){if(!e||!e.length)return;const a=e.map(n=>n.code).map(async n=>{var l,d;try{const r=await this.fetchKLineData(n);if(!r||!r.length)return;const i=(l=r[r.length-1])==null?void 0:l.value[1],c=(d=r[r.length-2])==null?void 0:d.value[1];if(i&&c){const m=Number(((i-c)/c*100).toFixed(2));t(n,{klineData:r,price:i,change:m})}}catch(r){console.error(`获取股票${n}的K线数据失败:`,r)}});await Promise.all(a)},200));this.quoteSessionId=null,this.klineDataCache=new Map,this.klineDataLoading=new Set,this.updateQueue=new Set,this.updateTimer=null}async getKLineDataFromDB(e){try{const t=await _.getData(C.KLINE_DATA,e);return t&&new Date().getTime()-t.timestamp<15*60*1e3?t.data:null}catch(t){return console.error("从IndexedDB获取K线数据失败:",t),null}}async saveKLineDataToDB(e,t){try{await _.saveData(C.KLINE_DATA,t,e)}catch(o){console.error("保存K线数据到IndexedDB失败:",o)}}async fetchDragonStocks(){const t=await(await fetch("https://www.wttiao.com/moni/ztpool/dragonCallback")).json();if(t.code===0&&t.data&&Array.isArray(t.data))return t.data.map(o=>({code:o.code,name:o.name,date:o.date,zttj_days:o.zttj_days,zttj_ct:o.zttj_ct,reason_type:o.reason_type||"",price:null,change:null}));throw new Error(t.msg||"获取数据失败")}async fetchKLineData(e){try{if(this.klineDataCache.has(e))return this.klineDataCache.get(e);const t=await this.getKLineDataFromDB(e);if(t)return this.klineDataCache.set(e,t),t;const o=e.startsWith("6")?`1.${e}`:`0.${e}`,a=new Date,n=`${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}${String(a.getDate()).padStart(2,"0")}`,l=`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${o}&ut=fa5fd1943c7b386f172d6893dbfba10b&fields1=f1%2Cf2%2Cf3%2Cf4%2Cf5%2Cf6&fields2=f51%2Cf52%2Cf53%2Cf54%2Cf55%2Cf56%2Cf57%2Cf58%2Cf59%2Cf60%2Cf61&klt=101&fqt=1&end=${n}&lmt=30`,r=await(await fetch(l)).json();if(r.rc===0&&r.data&&r.data.klines){const i=r.data.klines.map(c=>{const[m,v,$,I,x]=c.split(",");return{date:m,value:[parseFloat(v),parseFloat($),parseFloat(x),parseFloat(I)]}}).filter(c=>!isNaN(c.value[0])&&!isNaN(c.value[1])&&!isNaN(c.value[2])&&!isNaN(c.value[3]));if(i.length>0)return this.klineDataCache.set(e,i),await this.saveKLineDataToDB(e,i),i}return[]}catch(t){return console.error("获取K线数据失败:",t),[]}}registerQuotePush(e,t){if(e.length!==0)return this.quoteSessionId&&P(this.quoteSessionId),this.quoteSessionId=M(e,A(t,100)),this.quoteSessionId}unregisterQuotePush(){this.quoteSessionId&&(P(this.quoteSessionId),this.quoteSessionId=null)}dispose(){this.unregisterQuotePush(),this.updateTimer&&clearTimeout(this.updateTimer),this.klineDataCache.clear(),this.klineDataLoading.clear(),this.updateQueue.clear()}}const g=new Y;const G={name:"StockPool",components:{Delete:j,Trophy:O,Star:b,TrendCharts:T,StockTable:E,StockPoolHeader:W},props:{loading:{type:Boolean,default:!1}},data(){return{stockPool:[],loadingDragonPool:!1,loadingPrices:!1,sortField:"",sortOrder:"desc",addingToSelf:!1,showKLine:localStorage.getItem("showKLine")!=="false"}},created(){this.initIndexedDB().then(()=>{this.loadDragonStockPool(),this.$nextTick(()=>{this.refreshStockPrices()})})},beforeUnmount(){g.dispose()},computed:{leftTableData(){const s=Math.ceil(this.sortedStockPool.length/2);return this.sortedStockPool.slice(0,s)},rightTableData(){const s=Math.ceil(this.sortedStockPool.length/2);return this.sortedStockPool.slice(s)},sortedStockPool(){return this.sortField?[...this.stockPool].sort((s,e)=>{var a,n;let t=s[this.sortField],o=e[this.sortField];if(t===null&&o===null)return 0;if(t===null)return 1;if(o===null)return-1;if(this.sortField==="reason_type"){const l=((a=t.split("+")[0])==null?void 0:a.trim())||"",d=((n=o.split("+")[0])==null?void 0:n.trim())||"";return this.sortOrder==="asc"?l.localeCompare(d):d.localeCompare(l)}return typeof t=="number"&&typeof o=="number"?this.sortOrder==="asc"?t-o:o-t:this.sortOrder==="asc"?String(t).localeCompare(String(o)):String(o).localeCompare(String(t))}):this.stockPool}},methods:{async initIndexedDB(){try{await _.init()}catch(s){console.error("初始化数据库失败:",s),this.$emit("show-message",{type:"error",message:"初始化数据库失败: "+s.message})}},async loadDragonStockPool(){this.loadingDragonPool=!0;try{const s=await g.fetchDragonStocks();await this.updateStockPool(s),await this.registerQuotePush()}catch(s){console.error("加载龙头股票池失败:",s),this.$emit("show-message",{type:"error",message:"加载龙头股票池失败: "+s.message})}finally{this.loadingDragonPool=!1}},async updateStockPool(s){const e=this.stockPool.map(o=>o.code),t=s.filter(o=>!e.includes(o.code));this.stockPool=[...this.stockPool,...t],this.$emit("stock-pool-updated",this.stockPool),this.$emit("show-message",{type:"success",message:`成功加载${t.length}只龙头股票到股票池`}),g.loadKLineData(t,(o,a)=>{const n=this.stockPool.findIndex(l=>l.code===o);n!==-1&&Object.assign(this.stockPool[n],a)})},async registerQuotePush(){const s=this.stockPool.map(e=>e.code);g.registerQuotePush(s,e=>{e.forEach(t=>{const o=this.stockPool.find(a=>a.code===t.code);if(o){const a={};t.price!==void 0&&t.price!==null&&(a.price=t.price),t.zhangdiefu!==void 0&&t.zhangdiefu!==null&&(a.change=t.zhangdiefu),Object.keys(a).length>0&&Object.assign(o,a)}})})},async refreshStockPrices(){if(this.stockPool.length===0){this.$emit("show-message",{type:"warning",message:"股票池为空，无需刷新"});return}this.loadingPrices=!0;try{const s=this.stockPool.map(e=>e.code);g.registerQuotePush(s,this.handleQuoteData),this.$emit("show-message",{type:"success",message:"股票价格推送注册成功"})}catch(s){console.error("刷新股票价格失败:",s),this.$emit("show-message",{type:"error",message:"刷新股票价格失败: "+s.message})}finally{this.loadingPrices=!1}},handleRowClick(s){const e=this.stockPool.map(t=>t.code);R(s.code,e)},handleSortChange({prop:s,order:e}){if(!s){this.sortField="",this.sortOrder="desc";return}this.sortField=s,this.sortOrder=e==="ascending"?"asc":"desc",this.$nextTick(()=>{this.stockPool=[...this.sortedStockPool]})},async handleAddAllToSelf(){this.addingToSelf=!0;try{const s=this.stockPool.map(e=>e.code);await L(s),this.$emit("show-message",{type:"success",message:"所有股票已添加到自选股"})}catch(s){console.error("添加自选股失败:",s),this.$emit("show-message",{type:"error",message:"添加自选股失败: "+s.message})}finally{this.addingToSelf=!1}}}},J={class:"card-header"},X={class:"tables-container"};function Z(s,e,t,o,a,n){const l=u("stock-pool-header"),d=u("stock-table"),r=u("el-card");return p(),y(r,{class:"stock-pool-card","body-style":{padding:"20px"}},{header:f(()=>[k("div",J,[e[2]||(e[2]=k("span",{class:"title"},"股票池管理",-1)),h(l,{"stock-pool":a.stockPool,"show-k-line":a.showKLine,"onUpdate:showKLine":e[0]||(e[0]=i=>a.showKLine=i),onShowMessage:e[1]||(e[1]=i=>s.$emit("show-message",i))},null,8,["stock-pool","show-k-line"])])]),default:f(()=>[k("div",X,[(p(!0),K(z,null,Q([n.leftTableData,n.rightTableData],(i,c)=>(p(),y(d,{key:c,"table-data":i,loading:t.loading,"show-k-line":a.showKLine,onRowClick:n.handleRowClick,onSortChange:n.handleSortChange},null,8,["table-data","loading","show-k-line","onRowClick","onSortChange"]))),128))])]),_:1})}const re=D(G,[["render",Z],["__scopeId","data-v-18ba74b6"]]);export{re as default};
//# sourceMappingURL=StockPool-d283d8ff.js.map
