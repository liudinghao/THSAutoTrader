import{_ as M,m as Y,H as E,I as L,p as P,J as T,k as C,c as b,r as _,o as i,g as r,b as t,d as o,w as c,a as V,j as z,f as d,E as u,e as p,n as x}from"./index-b2bdff4a.js";import{e as A}from"./auctionPreselect-90dc72a8.js";import{j}from"./quoteApi-9e449949.js";import{a as I}from"./axios-3a665b0f.js";const U={name:"Backtest",components:{TrendCharts:Y,Calendar:E,Search:L,DataAnalysis:P,Download:T},setup(){const m=C(""),l=C(!1),h=C([]),a=C(!1),y=b(()=>{if(h.value.length===0)return{successCount:0,validCount:0,successRate:null};const n=h.value.filter(e=>e.auction_change!==null&&e.auction_change!==void 0&&e.close_change!==null&&e.close_change!==void 0),s=n.length;if(s===0)return{successCount:0,validCount:0,successRate:null};const f=n.filter(e=>parseFloat(e.close_change)>parseFloat(e.auction_change)).length,v=(f/s*100).toFixed(1);return{successCount:f,validCount:s,successRate:parseFloat(v)}}),S=b(()=>y.value.successCount),D=b(()=>y.value.validCount),g=b(()=>y.value.successRate),k=async()=>{if(!m.value){u.warning("请先选择日期");return}l.value=!0;try{const n=await A({date:m.value,minChange:3,maxChange:5,onProgress:(s,f)=>{console.log(`[${f}%] ${s}`)}});h.value=n.stocks.map(s=>({...s,next_day_return:null,next_day_close:null})),u.success(`获取到 ${n.originalCount} 只股票，过滤后 ${n.filteredCount} 只符合3%-5%竞价涨跌幅条件`)}catch(n){console.error("竞价选股策略执行失败:",n),u.error(`回测失败: ${n.message}`),h.value=[]}finally{l.value=!1}};return{selectedDate:m,loading:l,stockList:h,saving:a,successCount:S,validCount:D,successRate:g,fetchBacktestData:k,onDateChange:n=>{n&&k()},formatMarketCap:n=>{if(n==null)return"--";const s=parseFloat(n);return isNaN(s)?"--":(s/1e8).toFixed(2)},getReturnClass:n=>{const s=parseFloat(n);return isNaN(s)?"":s>0?"positive-return":s<0?"negative-return":"zero-return"},handleStockClick:n=>{try{const s=h.value.map(f=>f.code);j(n.code,s),u.success(`正在跳转到 ${n.name}(${n.code}) 的分时图`)}catch(s){console.error("跳转分时图失败:",s),u.error("跳转分时图失败，请检查API连接")}},saveStockPickResults:async()=>{var n;if(!h.value||h.value.length===0){u.warning("没有可保存的选股结果");return}if(!m.value){u.warning("缺少回测日期信息");return}a.value=!0;try{const s=h.value.map(e=>({code:e.code,name:e.name,status:0,message:"集合竞价选股法",buy_point:e.reason_type||"集合竞价买入"})),f={date:m.value,type:2,stockList:s},v=await I.post("https://www.wttiao.com/moni/ztpool/stock-pick/batch",f,{headers:{"Content-Type":"application/json"},timeout:1e4});if(v.status===200)u.success(`成功保存 ${s.length} 只股票的选股结果`);else throw new Error(`API返回状态码: ${v.status}`)}catch(s){console.error("保存选股结果失败:",s),s.code==="ECONNREFUSED"?u.error("连接失败：请确保后端服务运行在 localhost:3000"):s.message.includes("timeout")?u.error("保存超时，请稍后重试"):s.response?u.error(`保存失败：${((n=s.response.data)==null?void 0:n.message)||s.response.statusText}`):u.error(`保存失败：${s.message}`)}finally{a.value=!1}}}}},q={class:"backtest-container"},H={class:"page-header"},J={class:"header-content"},O={class:"header-icon"},Q={class:"controls-section"},W={class:"controls-card"},G={class:"card-header"},K={class:"card-content"},X={class:"form-row"},Z={class:"form-controls"},$={class:"strategy-info"},ee={key:0,class:"results-section"},se={class:"results-card"},te={class:"results-header"},ae={class:"results-title"},ne={class:"header-actions"},oe={class:"stats-grid"},le={class:"stat-card"},ce={class:"stat-value"},de={class:"stat-card"},ie={class:"stat-value"},re={key:0,class:"stat-card"},_e={class:"stat-value success-rate-value"},ue={class:"stat-label"},he={class:"table-container"},fe=["onClick"],ge={class:"stock-code"},ve={class:"stock-name"},me={class:"reason-text"},pe={key:1,class:"no-data"},ye={key:1,class:"no-data"},ke={key:1,class:"no-data"},Ce={key:1,class:"no-data"},be={key:1,class:"no-data-message"},xe={key:2,class:"welcome-message"};function De(m,l,h,a,y,S){const D=_("TrendCharts"),g=_("el-icon"),k=_("Calendar"),N=_("el-date-picker"),B=_("Search"),R=_("el-button"),w=_("el-tag"),F=_("DataAnalysis"),n=_("Download"),s=_("el-table-column"),f=_("el-table"),v=_("el-empty");return i(),r("div",q,[t("div",H,[t("div",J,[t("div",O,[o(g,{size:"32",color:"#409eff"},{default:c(()=>[o(D)]),_:1})]),l[1]||(l[1]=t("div",{class:"header-text"},[t("h2",null,"集合竞价回测"),t("p",{class:"page-description"},"基于历史数据验证集合竞价选股策略的有效性")],-1))])]),t("div",Q,[t("div",W,[t("div",G,[o(g,{size:"16",color:"#606266"},{default:c(()=>[o(k)]),_:1}),l[2]||(l[2]=t("span",{class:"card-title"},"回测配置",-1))]),t("div",K,[t("div",X,[l[3]||(l[3]=t("label",{class:"form-label"},"回测日期",-1)),t("div",Z,[o(N,{modelValue:a.selectedDate,"onUpdate:modelValue":l[0]||(l[0]=e=>a.selectedDate=e),type:"date",placeholder:"选择回测日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",onChange:a.onDateChange,disabled:a.loading,size:"default"},null,8,["modelValue","onChange","disabled"]),o(R,{type:"primary",onClick:a.fetchBacktestData,loading:a.loading,disabled:!a.selectedDate,size:"default"},{icon:c(()=>[o(g,null,{default:c(()=>[o(B)]),_:1})]),default:c(()=>[p(" "+d(a.loading?"分析中...":"开始回测"),1)]),_:1},8,["onClick","loading","disabled"])])]),t("div",$,[o(w,{type:"info",size:"small"},{default:c(()=>l[4]||(l[4]=[p("策略：集合竞价选股")])),_:1,__:[4]}),o(w,{type:"warning",size:"small"},{default:c(()=>l[5]||(l[5]=[p("条件：竞价涨跌幅 3%-5%")])),_:1,__:[5]})])])])]),a.stockList.length>0||a.loading?(i(),r("div",ee,[t("div",se,[t("div",te,[t("div",ae,[o(g,{size:"18",color:"#409eff"},{default:c(()=>[o(F)]),_:1}),l[6]||(l[6]=t("h3",null,"回测结果",-1))]),t("div",ne,[a.stockList.length>0?(i(),V(R,{key:0,type:"success",onClick:a.saveStockPickResults,loading:a.saving,disabled:a.saving,size:"default",round:""},{icon:c(()=>[o(g,null,{default:c(()=>[o(n)]),_:1})]),default:c(()=>[p(" "+d(a.saving?"保存中...":"保存选股结果"),1)]),_:1},8,["onClick","loading","disabled"])):z("",!0)])]),t("div",oe,[t("div",le,[t("div",ce,d(a.stockList.length),1),l[7]||(l[7]=t("div",{class:"stat-label"},"符合条件股票",-1))]),t("div",de,[t("div",ie,d(a.selectedDate||"--"),1),l[8]||(l[8]=t("div",{class:"stat-label"},"回测日期",-1))]),l[9]||(l[9]=t("div",{class:"stat-card"},[t("div",{class:"stat-value"},"3%-5%"),t("div",{class:"stat-label"},"竞价涨跌幅")],-1)),a.successRate!==null?(i(),r("div",re,[t("div",_e,d(a.successRate)+"%",1),t("div",ue,"成功率 ("+d(a.successCount)+"/"+d(a.validCount)+")",1)])):z("",!0)])]),t("div",he,[o(f,{data:a.stockList,loading:a.loading,stripe:"",height:"600",class:"stock-table","header-cell-style":{backgroundColor:"#f8f9fa",color:"#495057",fontWeight:"600"},"row-style":{cursor:"default"}},{default:c(()=>[o(s,{prop:"code",label:"股票",width:"100"},{default:c(({row:e})=>[t("div",{class:"stock-info",onClick:Re=>a.handleStockClick(e),title:"点击跳转到分时图"},[t("div",ge,d(e.code),1),t("div",ve,d(e.name),1)],8,fe)]),_:1}),o(s,{prop:"zsz",label:"市值(亿)",width:"90"},{default:c(({row:e})=>[p(d(a.formatMarketCap(e.zsz)),1)]),_:1}),o(s,{prop:"reason_type",label:"选股原因",width:"auto"},{default:c(({row:e})=>[t("div",me,d(e.reason_type||"--"),1)]),_:1}),o(s,{prop:"auction_change",label:"竞价(%)",width:"90"},{default:c(({row:e})=>[e.auction_change!==null&&e.auction_change!==void 0?(i(),r("span",{key:0,class:x(a.getReturnClass(e.auction_change))},d(e.auction_change)+"% ",3)):(i(),r("span",pe,"--"))]),_:1}),o(s,{prop:"close_change",label:"收盘涨幅",width:"90"},{default:c(({row:e})=>[e.close_change!==null&&e.close_change!==void 0?(i(),r("span",{key:0,class:x(a.getReturnClass(e.close_change))},d(e.close_change)+"% ",3)):(i(),r("span",ye,"--"))]),_:1}),o(s,{prop:"next_day_return",label:"次日开盘",width:"90"},{default:c(({row:e})=>[e.next_day_return!==null&&e.next_day_return!==void 0?(i(),r("span",{key:0,class:x(a.getReturnClass(e.next_day_return))},d(e.next_day_return)+"% ",3)):(i(),r("span",ke,"--"))]),_:1}),o(s,{prop:"next_day_close",label:"次日收盘",width:"90"},{default:c(({row:e})=>[e.next_day_close!==null&&e.next_day_close!==void 0?(i(),r("span",{key:0,class:x(a.getReturnClass(e.next_day_close))},d(e.next_day_close)+"% ",3)):(i(),r("span",Ce,"--"))]),_:1}),o(s,{prop:"date",label:"涨停日期",width:"100"})]),_:1},8,["data","loading"])])])):!a.loading&&a.selectedDate?(i(),r("div",be,[o(v,{description:"该日期没有找到回测数据"})])):a.selectedDate?z("",!0):(i(),r("div",xe,[o(v,{description:"请选择日期开始回测"})]))])}const Be=M(U,[["render",De],["__scopeId","data-v-ad6945e2"]]);export{Be as default};
//# sourceMappingURL=Backtest-3d4ea8ae.js.map
